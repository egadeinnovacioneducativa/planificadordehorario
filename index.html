<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario Inteligente Pro - 12 Semanas</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Configuración de Impresión Horizontal Forzada */
        @media print {
            @page { 
                size: landscape; 
                margin: 5mm; 
            }
            html, body { 
                width: 100%; 
                margin: 0 !important; 
                background: white !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            .no-print { display: none !important; }
            .print-container { 
                display: block !important; 
                width: 100% !important; 
                zoom: 85%; 
            }
            .print-page-break { 
                page-break-after: always !important; 
                break-after: page !important; 
                margin-bottom: 0 !important; 
                padding-top: 5mm; 
            }
            /* Asegurar que el texto sea visible en impresión */
            .print-text {
                display: block !important;
                white-space: pre-wrap;
            }
        }

        .print-container { display: none; }
        .no-select { -webkit-user-select: none; user-select: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .auto-expand { resize: none; overflow: hidden; min-height: 24px; }
        
        .grouped-cell { 
            transition: background-color 0.2s, transform 0.1s; 
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        // Iconos SVG internos
        const AlertTriangle = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>
            </svg>
        );

        const Clock = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
        );

        const Printer = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/>
            </svg>
        );

        const MousePointer2 = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="m13 13 6 6"/>
            </svg>
        );

        const RotateCcw = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>
            </svg>
        );

        const CATEGORIES = {
            EMPTY: { id: 'empty', label: 'Vacío', color: 'bg-slate-100', text: 'text-slate-400', countType: null },
            CLASES: { id: 'clases', label: 'Clases (Aula)', color: 'bg-blue-500', text: 'text-white', countType: 'clases' },
            AUTONOMO: { id: 'autonomo', label: 'Trabajo Autónomo', color: 'bg-green-500', text: 'text-white', countType: 'autonomo' },
            INSIGNIAS: { id: 'insignias', label: 'Exp. Insignias', color: 'bg-yellow-400', text: 'text-slate-900', countType: 'experiencias' },
            ACTIVACION: { id: 'activacion', label: 'Exp. Activación', color: 'bg-pink-400', text: 'text-white', countType: 'experiencias' },
            MICRO: { id: 'micro', label: 'Microexperiencias', color: 'bg-orange-500', text: 'text-white', countType: 'experiencias' },
        };

        const LIMITS = {
            clases: { label: 'Clases', limit: 15 },
            autonomo: { label: 'T. Autónomo', limit: 30 },
            experiencias: { label: 'Experiencias', limit: 5 }
        };

        const generateTimeBlocks = () => {
            const blocks = [];
            let current = 8 * 60; 
            const end = 18.5 * 60; 
            while (current < end) {
                const h = Math.floor(current / 60);
                const m = current % 60;
                const next = current + 30;
                const nh = Math.floor(next / 60);
                const nm = next % 60;
                blocks.push({
                    start: `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`,
                    end: `${nh.toString().padStart(2, '0')}:${nm.toString().padStart(2, '0')}`,
                    duration: 0.5
                });
                current = next;
            }
            return blocks;
        };

        const TIME_BLOCKS = generateTimeBlocks();
        const DAYS = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
        const TOTAL_WEEKS = 12; // Actualizado a 12 semanas

        // --- COMPONENTES AUXILIARES ---

        const ScheduleCell = ({ startIdx, cell, cat, isPrint, rowSpan, onNoteChange, onInteraction }) => {
            const textareaRef = useRef(null);

            useEffect(() => {
                if (textareaRef.current) {
                    textareaRef.current.style.height = "0px";
                    textareaRef.current.style.height = textareaRef.current.scrollHeight + "px";
                }
            }, [cell.note, rowSpan]);

            if (rowSpan === 0) return null;

            const handleMouseDown = (e) => {
                if (isPrint) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                const relativeIdx = Math.floor((offsetY / rect.height) * rowSpan);
                onInteraction('down', startIdx + relativeIdx);
            };

            const handleMouseUp = (e) => {
                if (isPrint) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                const relativeIdx = Math.floor((offsetY / rect.height) * rowSpan);
                onInteraction('up', startIdx + relativeIdx);
            };

            return (
                <td rowSpan={rowSpan} className="p-1 align-top">
                    <div
                        onMouseDown={handleMouseDown}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={() => onInteraction('leave')}
                        className={`w-full h-full min-h-[60px] rounded-xl p-2 flex flex-col items-center justify-start relative select-none border-2 grouped-cell
                            ${cat.color} ${cat.text} ${cell.catId === 'empty' ? 'border-dashed border-slate-200' : 'border-transparent shadow-sm hover:brightness-95'}
                            ${cell.isPainPoint ? 'ring-4 ring-red-600 border-red-500 scale-[0.98] shadow-inner' : ''}
                            ${isPrint ? '' : 'cursor-pointer'}
                        `}
                    >
                        <span className="text-[7px] font-black uppercase text-center leading-tight mb-1 opacity-70 tracking-tighter">
                            {cat.label}
                        </span>

                        {cell.catId !== 'empty' && (
                            isPrint ? (
                                <div className={`w-full text-[12px] text-center font-black leading-tight whitespace-pre-wrap ${cat.text}`}>
                                    {cell.note}
                                </div>
                            ) : (
                                <textarea
                                    ref={textareaRef}
                                    value={cell.note}
                                    onChange={(e) => onNoteChange(e.target.value)}
                                    onMouseDown={(e) => e.stopPropagation()}
                                    onMouseUp={(e) => e.stopPropagation()}
                                    placeholder="..."
                                    className={`w-full bg-transparent border-none outline-none text-[12px] text-center font-black leading-tight auto-expand placeholder:text-current placeholder:opacity-20
                                        ${cat.text}
                                    `}
                                />
                            )
                        )}
                        
                        {cell.isPainPoint && (
                            <div className="absolute top-1 right-1 w-4 h-4 bg-red-600 rounded-full border border-white flex items-center justify-center shadow-md">
                                <AlertTriangle size={10} className="text-white fill-white" />
                            </div>
                        )}
                    </div>
                </td>
            );
        };

        const WeekTable = ({ weekData, weekLabel, totals, trimestre, isPrint, handleNoteChange, handleCategoryChange, togglePainPoint, timerRef, isLongPress }) => {
            const getGroupedData = (dayData) => {
                const groups = [];
                let i = 0;
                while (i < dayData.length) {
                    let count = 1;
                    const currentCat = dayData[i].catId;
                    const isPain = dayData[i].isPainPoint;
                    if (currentCat !== 'empty') {
                        while (i + count < dayData.length && 
                               dayData[i + count].catId === currentCat && 
                               dayData[i + count].isPainPoint === isPain) {
                            count++;
                        }
                    }
                    groups.push({ span: count });
                    for (let j = 1; j < count; j++) groups.push({ span: 0 });
                    i += count;
                }
                return groups;
            };

            const dayGroups = useMemo(() => {
                const obj = {};
                DAYS.forEach(day => obj[day] = getGroupedData(weekData[day]));
                return obj;
            }, [weekData]);

            return (
                <div className={`${isPrint ? 'print-page-break' : ''}`}>
                    {isPrint && (
                        <div className="flex justify-between items-center mb-6 px-2">
                            <div>
                                <h1 className="text-3xl font-black text-slate-900 leading-tight uppercase tracking-tighter">PROGRAMA ACADÉMICO SEMANAL</h1>
                                <p className="text-slate-500 text-sm font-bold uppercase tracking-widest mt-1">Plan de Gestión del Tiempo</p>
                            </div>
                            <img src="https://image.admisiones.tec.mx/lib/fe2b11747364057f721176/m/1/b910ad21-1913-4ce0-8f35-38c908814125.png" alt="Logo" className="w-48 object-contain" />
                        </div>
                    )}

                    <div className="flex justify-between items-end mb-4">
                        <div className="flex gap-6 items-end">
                            <div className="flex flex-col">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Trimestre</span>
                                <span className="text-lg font-bold text-slate-800 border-b-2 border-slate-100 min-w-[140px]">{trimestre || "—"}</span>
                            </div>
                            <div className="flex flex-col">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Periodo</span>
                                <span className="text-lg font-bold text-indigo-600 border-b-2 border-indigo-100 min-w-[120px]">{weekLabel}</span>
                            </div>
                        </div>
                        
                        <div className="flex gap-3">
                            {Object.entries(LIMITS).map(([key, config]) => {
                                const current = totals[key];
                                const isOver = current > config.limit;
                                return (
                                    <div key={key} className={`flex flex-col items-center justify-center px-6 py-2 rounded-xl transition-all ${isOver ? 'bg-red-600 text-white ring-4 ring-red-400 shadow-xl scale-110' : 'bg-white border-2 border-slate-200 shadow-sm'}`}>
                                        <span className={`text-[9px] font-black uppercase mb-1 tracking-tighter ${isOver ? 'text-red-100' : 'text-slate-400'}`}>{config.label}</span>
                                        <span className={`text-xl font-black flex items-center gap-2 ${isOver ? 'text-white' : 'text-slate-800'}`}>
                                            {isOver && <AlertTriangle size={18} className="fill-white text-red-600" />}
                                            {current.toFixed(1)} <span className={`text-xs ${isOver ? 'text-red-200' : 'text-slate-400'}`}>/ {config.limit}h</span>
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className={`overflow-hidden rounded-2xl border border-slate-200 bg-white ${isPrint ? '' : 'shadow-xl'}`}>
                        <table className="w-full border-collapse min-w-[800px] table-fixed">
                            <thead>
                                <tr className="bg-slate-800 text-white">
                                    <th className="p-3 text-left font-semibold text-xs w-24">Horario</th>
                                    {DAYS.map(day => <th key={day} className="p-3 text-center font-semibold text-xs uppercase tracking-widest">{day}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {TIME_BLOCKS.map((block, bIdx) => (
                                    <tr key={bIdx} className="border-b border-slate-50 last:border-0">
                                        <td className="p-2 bg-slate-50/30 border-r border-slate-100">
                                            <div className="text-sm font-black text-slate-800 leading-none">{block.start}</div>
                                            <div className="text-[8px] font-bold text-slate-400 mt-0.5 uppercase tracking-tighter">a {block.end}</div>
                                        </td>
                                        {DAYS.map(day => {
                                            const cell = weekData[day][bIdx];
                                            const group = dayGroups[day][bIdx];
                                            const cat = CATEGORIES[cell.catId.toUpperCase()] || CATEGORIES.EMPTY;
                                            let startIdx = bIdx;
                                            while (startIdx > 0 && dayGroups[day][startIdx].span === 0) startIdx--;

                                            return (
                                                <ScheduleCell 
                                                    key={day}
                                                    startIdx={startIdx}
                                                    cell={cell}
                                                    cat={cat}
                                                    isPrint={isPrint}
                                                    rowSpan={group.span}
                                                    onNoteChange={(val) => handleNoteChange(day, bIdx, val)}
                                                    onInteraction={(type, targetIdx) => {
                                                        if (type === 'down') {
                                                            isLongPress.current = false;
                                                            timerRef.current = setTimeout(() => {
                                                                togglePainPoint(day, targetIdx);
                                                                isLongPress.current = true;
                                                            }, 600);
                                                        } else if (type === 'up') {
                                                            clearTimeout(timerRef.current);
                                                            if (!isLongPress.current) handleCategoryChange(day, targetIdx);
                                                        } else {
                                                            clearTimeout(timerRef.current);
                                                        }
                                                    }}
                                                />
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---

        function App() {
            const [schedules, setSchedules] = useState(() => {
                return Array.from({ length: TOTAL_WEEKS }, () => {
                    const week = {};
                    DAYS.forEach(day => {
                        week[day] = TIME_BLOCKS.map(() => ({ catId: 'empty', isPainPoint: false, note: '' }));
                    });
                    return week;
                });
            });

            const [activeWeekIndex, setActiveWeekIndex] = useState(0);
            const [trimestre, setTrimestre] = useState("");
            const timerRef = useRef(null);
            const isLongPress = useRef(false);

            const activeWeekTotals = useMemo(() => {
                const counts = { clases: 0, autonomo: 0, experiencias: 0 };
                const currentWeek = schedules[activeWeekIndex];
                DAYS.forEach(day => {
                    currentWeek[day].forEach((cell) => {
                        const catConfig = CATEGORIES[cell.catId.toUpperCase()];
                        if (catConfig && catConfig.countType) counts[catConfig.countType] += 0.5;
                    });
                });
                return counts;
            }, [schedules, activeWeekIndex]);

            const getWeekTotals = (index) => {
                const counts = { clases: 0, autonomo: 0, experiencias: 0 };
                const currentWeek = schedules[index];
                DAYS.forEach(day => {
                    currentWeek[day].forEach((cell) => {
                        const catConfig = CATEGORIES[cell.catId.toUpperCase()];
                        if (catConfig && catConfig.countType) counts[catConfig.countType] += 0.5;
                    });
                });
                return counts;
            };

            const handleCategoryChange = (day, targetIndex) => {
                const newSchedules = [...schedules];
                const week = newSchedules[activeWeekIndex];
                const cell = week[day][targetIndex];
                const keys = Object.values(CATEGORIES).map(c => c.id);
                const nextIndex = (keys.indexOf(cell.catId) + 1) % keys.length;
                week[day][targetIndex] = { ...cell, catId: keys[nextIndex] };
                setSchedules(newSchedules);
            };

            const handleNoteChange = (day, targetIndex, value) => {
                const newSchedules = [...schedules];
                newSchedules[activeWeekIndex][day][targetIndex].note = value;
                setSchedules(newSchedules);
            };

            const togglePainPoint = (day, targetIndex) => {
                const newSchedules = [...schedules];
                const week = newSchedules[activeWeekIndex];
                const cell = week[day][targetIndex];
                week[day][targetIndex] = { ...cell, isPainPoint: !cell.isPainPoint };
                setSchedules(newSchedules);
            };

            return (
                <div className="min-h-screen p-4 md:p-8 font-sans no-select relative">
                    <div className="max-w-6xl mx-auto no-print">
                        <div className="absolute top-4 right-4 md:top-8 md:right-8 w-32 md:w-48">
                            <img src="https://image.admisiones.tec.mx/lib/fe2b11747364057f721176/m/1/b910ad21-1913-4ce0-8f35-38c908814125.png" alt="Logo Tec" className="w-full h-auto" />
                        </div>

                        <header className="mb-6 pr-36">
                            <div className="flex flex-col md:flex-row md:items-start justify-between gap-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-slate-800 tracking-tighter">Planificador Académico</h1>
                                    <p className="text-slate-500 text-sm mt-1 flex items-center gap-2">
                                        <MousePointer2 size={14} className="text-blue-500" /> Clic cambia un bloque • <span className="font-bold text-red-600 tracking-tighter">Mantén presionado</span> para Dolor
                                    </p>
                                </div>
                                <div className="flex flex-col items-end gap-2">
                                    <div className="flex gap-2">
                                        <button onClick={() => {
                                            if (window.confirm("¿Deseas reiniciar las 12 semanas?")) {
                                                setSchedules(Array.from({ length: TOTAL_WEEKS }, () => {
                                                    const week = {};
                                                    DAYS.forEach(day => week[day] = TIME_BLOCKS.map(() => ({ catId: 'empty', isPainPoint: false, note: '' })));
                                                    return week;
                                                }));
                                                setTrimestre("");
                                            }
                                        }} className="flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-300 hover:bg-red-50 hover:text-red-600 rounded-lg shadow-sm text-xs font-bold transition-all">
                                            <RotateCcw size={14} /> Reiniciar Todo
                                        </button>
                                        <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-md text-xs font-bold transition-all active:scale-95">
                                            <Printer size={14} /> Guardar-Imprimir
                                        </button>
                                    </div>
                                    {/* Selector de Semanas: 2 filas de 6 */}
                                    <div className="grid grid-cols-6 gap-1 bg-slate-200 p-1 rounded-xl w-fit ml-auto shadow-inner">
                                        {Array.from({ length: TOTAL_WEEKS }, (_, i) => (
                                            <button 
                                                key={i}
                                                onClick={() => setActiveWeekIndex(i)}
                                                className={`px-3 py-1.5 rounded-lg text-[10px] font-black transition-all ${activeWeekIndex === i ? 'bg-white text-indigo-600 shadow-sm scale-110' : 'text-slate-500 hover:bg-slate-300'}`}
                                            >
                                                S{i + 1}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </header>

                        <div className="mb-8 max-w-[220px]">
                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Ciclo Escolar / Trimestre</label>
                            <input 
                                type="text" 
                                value={trimestre} 
                                onChange={(e) => setTrimestre(e.target.value)}
                                placeholder="Ej. Enero - Marzo 2024"
                                className="w-full bg-transparent border-b-2 border-slate-200 focus:border-indigo-500 outline-none pb-1 font-bold text-slate-700 transition-colors"
                            />
                        </div>

                        <div key={activeWeekIndex} className="fade-in">
                            <WeekTable 
                                weekData={schedules[activeWeekIndex]} 
                                weekLabel={`Semana ${activeWeekIndex + 1}`} 
                                totals={activeWeekTotals}
                                trimestre={trimestre}
                                isPrint={false}
                                handleNoteChange={handleNoteChange}
                                handleCategoryChange={handleCategoryChange}
                                togglePainPoint={togglePainPoint}
                                timerRef={timerRef}
                                isLongPress={isLongPress}
                            />
                        </div>

                        {/* Leyenda */}
                        <div className="mt-8 flex flex-wrap items-center justify-center gap-6 py-5 border-t border-slate-200 bg-white/50 rounded-b-2xl">
                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-blue-500 shadow-sm"></div><span className="text-[10px] font-black text-blue-600 uppercase tracking-tighter">Clases (Aula)</span></div>
                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-green-500 shadow-sm"></div><span className="text-[10px] font-black text-green-600 uppercase tracking-tighter">Trabajo Autónomo</span></div>
                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-yellow-400 shadow-sm"></div><span className="text-[10px] font-black text-yellow-600 uppercase tracking-tighter">Exp. Insignias</span></div>
                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-pink-400 shadow-sm"></div><span className="text-[10px] font-black text-pink-500 uppercase tracking-tighter">Exp. Activación</span></div>
                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded-full bg-orange-500 shadow-sm"></div><span className="text-[10px] font-black text-orange-600 uppercase tracking-tighter">Microexperiencias</span></div>
                            <div className="flex items-center gap-2 ml-4 pl-4 border-l border-slate-300"><div className="w-4 h-4 rounded-full border-2 border-red-600 bg-white flex items-center justify-center shadow-sm"><div className="w-1.5 h-1.5 bg-red-600 rounded-full"></div></div><span className="text-[10px] font-black text-red-600 uppercase tracking-tighter">Punto de Dolor</span></div>
                        </div>
                    </div>

                    <div className="print-container no-select">
                        {schedules.map((week, idx) => (
                            <WeekTable 
                                key={idx}
                                weekData={week}
                                weekLabel={`Semana ${idx + 1}`}
                                totals={getWeekTotals(idx)}
                                trimestre={trimestre}
                                isPrint={true}
                                handleNoteChange={handleNoteChange}
                                handleCategoryChange={handleCategoryChange}
                                togglePainPoint={togglePainPoint}
                                timerRef={timerRef}
                                isLongPress={isLongPress}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
